<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï½œr4</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#1e293b; --sub:#64748b; --border:#cbd5e1;
      --primary:#0f766e; --primary-light:#ccfbf1;
      --ok:#15803d; --ok-bg:#dcfce7;
      --warn:#b45309; --warn-bg:#fef3c7;
      --danger:#b91c1c; --danger-bg:#fee2e2;
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;line-height:1.4}
    
    /* Layout */
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid-top{display:grid;grid-template-columns:1fr;gap:1.5rem;margin-bottom:1.5rem}
    @media(min-width:900px){.grid-top{grid-template-columns:350px 1fr}} /* Left:Inputs, Right:Dash */

    /* Card */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,0.05);overflow:hidden;border:1px solid var(--border);margin-bottom:1.5rem}
    .card-hd{padding:0.8rem 1rem;border-bottom:1px solid var(--border);background:#f1f5f9;display:flex;justify-content:space-between;align-items:center;font-weight:bold;color:var(--text)}
    .card-bd{padding:1.2rem}

    /* Inputs */
    label{display:block;font-size:0.8rem;color:var(--sub);font-weight:bold;margin-bottom:0.3rem}
    input,select{width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:6px;font-size:0.95rem;background:#fff;text-align:right}
    input:focus{outline:2px solid var(--primary);border-color:transparent}
    .input-group{margin-bottom:1rem}
    .row{display:flex;gap:0.8rem}
    .row > *{flex:1}
    
    /* Chips */
    .chips{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.3rem;justify-content:flex-end}
    .chip{font-size:0.75rem;padding:0.2rem 0.6rem;border:1px solid var(--border);border-radius:99px;background:#fff;cursor:pointer;color:var(--sub)}
    .chip:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}

    /* Dashboard (Result) */
    .status-box{padding:1.2rem;text-align:center;border-radius:var(--radius);margin-bottom:1.2rem;border:2px solid transparent}
    .status-box.ok{background:var(--ok-bg);border-color:var(--ok);color:var(--ok)}
    .status-box.ng{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
    .status-icon{font-size:1.8rem;display:block;margin-bottom:0.2rem}
    .status-main{font-size:1.6rem;font-weight:900}
    
    /* Bar Chart */
    .bar-chart-wrap{margin:1rem 0}
    .bar-track{height:2.2rem;background:#f1f5f9;border-radius:6px;overflow:hidden;display:flex;position:relative;margin-bottom:0.3rem}
    .bar-seg{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.75rem;font-weight:bold;white-space:nowrap;overflow:hidden;transition:width 0.4s ease}
    .bs-loan{background:#94a3b8} 
    .bs-now{background:#0f766e} 
    .bs-fut{background:#2dd4bf;color:#0f4c3a} 
    .bs-gap{background:#ef4444}
    
    /* Line Chart */
    .chart-container{position:relative;height:180px;width:100%;margin-top:1rem;border-left:1px solid var(--border);border-bottom:1px solid var(--border)}
    svg{width:100%;height:100%;overflow:visible}
    .line-target{stroke:#ef4444;stroke-width:2;stroke-dasharray:4}
    .line-plan{stroke:#0f766e;stroke-width:3;fill:none}
    .dot{stroke-width:2;r:4}

    /* PL Table */
    .tbl-wrap{overflow-x:auto}
    .tbl{width:100%;border-collapse:collapse;font-size:0.9rem;min-width:600px}
    .tbl th,.tbl td{padding:0.6rem;border-bottom:1px solid #e2e8f0;text-align:right}
    .tbl th{text-align:left;color:var(--sub);background:#f8fafc;width:140px;position:sticky;left:0}
    .tbl input{border:1px solid #e2e8f0;background:#fff;width:100%}
    .tbl input:focus{background:#fff;border-color:var(--primary)}
    .tbl tr:last-child td{font-weight:bold;background:#f0fdf4;border-bottom:none}

    /* Print */
    @media print{
      .no-print{display:none}
      body{background:#fff}
      .card{border:1px solid #000;box-shadow:none;page-break-inside:avoid}
      .grid-top{display:block}
    }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h1 style="font-size:1.3rem;margin:0">åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— <span style="font-size:0.8rem;font-weight:normal;color:var(--sub)">r4 (PLé€£å‹•ç‰ˆ)</span></h1>
    <button class="chip no-print" onclick="window.print()" style="font-weight:bold;font-size:0.9rem">ğŸ–¨ å°åˆ· / PDF</button>
  </div>

  <div class="grid-top">
    
    <div class="no-print-break">
      <section class="card">
        <div class="card-hd">1. ç›®æ¨™ã¨ç¾çŠ¶</div>
        <div class="card-bd">
          <div class="input-group">
            <label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
            <input id="price" type="text" data-fmt placeholder="80,000,000">
            <div class="chips">
              <button class="chip" data-set="price" data-val="50000000">5,000ä¸‡</button>
              <button class="chip" data-set="price" data-val="100000000">1å„„</button>
            </div>
          </div>

          <div class="row">
            <div class="input-group">
              <label>LTVï¼ˆå€Ÿå…¥ %ï¼‰</label>
              <input id="ltv" type="number" value="80">
            </div>
            <div class="input-group">
              <label>è«¸è²»ç”¨ï¼ˆ%ï¼‰</label>
              <input id="costRate" type="number" value="8">
            </div>
          </div>

          <div class="input-group">
            <label>å–å¾—æ™‚æœŸï¼ˆä½•ã‹æœˆå¾Œï¼‰</label>
            <input id="months" type="number" value="36">
            <div style="font-size:0.75rem;color:var(--sub);text-align:right" id="targetDate"></div>
          </div>

          <div class="input-group" style="margin-top:1.5rem;border-top:1px dashed var(--border);padding-top:1rem">
            <label>ç¾åœ¨ã®è‡ªå·±è³‡é‡‘ï¼ˆå††ï¼‰</label>
            <input id="cashNow" type="text" data-fmt placeholder="5,000,000">
          </div>
        </div>
      </section>
      
      <div style="font-size:0.85rem;color:var(--sub);padding:0 0.5rem">
        <p>â€»ä¸‹ã®ã€Œ3. äº‹æ¥­è¨ˆç”»(PL)ã€ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å³å´ã®ã‚°ãƒ©ãƒ•ã«ã€Œå°†æ¥ã®ç©ç«‹ã€ã¨ã—ã¦åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>

    <div>
      <div id="statusBox" class="status-box ng">
        <span class="status-icon" id="statusIcon">âš ï¸</span>
        <div class="status-main" id="statusText">åˆ¤å®šä¸èƒ½</div>
        <div style="font-size:0.9rem;opacity:0.9" id="statusSub">æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <section class="card">
        <div class="card-hd">2. è³‡é‡‘èª¿é”æ§‹æˆ</div>
        <div class="card-bd">
          
          <div style="font-size:0.8rem;display:flex;justify-content:space-between;font-weight:bold;margin-bottom:0.2rem">
            <span>å¿…è¦ç·é¡</span> <span id="labelTotal">Â¥0</span>
          </div>
          <div class="bar-track" style="height:1.5rem;background:#e2e8f0;margin-bottom:0.8rem">
             <div style="width:100%;color:#64748b;display:flex;align-items:center;justify-content:center;font-size:0.75rem">å¿…è¦è³‡é‡‘ (100%)</div>
          </div>

          <div style="font-size:0.8rem;display:flex;justify-content:space-between;font-weight:bold;margin-bottom:0.2rem">
            <span>èª¿é”å†…è¨³ï¼ˆç¾çŠ¶ï¼‹è¨ˆç”»ï¼‰</span> <span id="labelPrep">Â¥0</span>
          </div>
          <div class="bar-track">
            <div id="segLoan" class="bar-seg bs-loan" style="width:0%"></div>
            <div id="segNow" class="bar-seg bs-now" style="width:0%"></div>
            <div id="segFut" class="bar-seg bs-fut" style="width:0%"></div>
            <div id="segGap" class="bar-seg bs-gap" style="width:0%"></div>
          </div>
          
          <div style="display:flex;gap:0.8rem;flex-wrap:wrap;font-size:0.75rem;color:var(--sub);margin-top:0.5rem">
            <span style="color:#64748b">â– å€Ÿå…¥</span>
            <span style="color:#0f766e">â– ç¾åœ¨è³‡é‡‘</span>
            <span style="color:#2dd4bf;font-weight:bold">â– å°†æ¥ç©ç«‹(PL)</span>
            <span style="color:#ef4444;font-weight:bold">â– ä¸è¶³</span>
          </div>

          <div class="chart-container">
            <svg id="lineChart" viewBox="0 0 300 180" preserveAspectRatio="none"></svg>
            <div style="position:absolute;top:-5px;right:0;font-size:0.7rem;color:#ef4444;font-weight:bold">å¿…è¦é¡</div>
            <div style="position:absolute;bottom:-20px;left:0;font-size:0.7rem;color:var(--sub)">ç¾åœ¨</div>
            <div style="position:absolute;bottom:-20px;right:0;font-size:0.7rem;color:var(--sub)">3å¹´å¾Œ</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <section class="card">
    <div class="card-hd">
      <span>3. äº‹æ¥­è¨ˆç”» (3ã‚«å¹´PL / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼)</span>
      <small style="font-weight:normal">ã“ã“ã§è¨ˆç®—ã•ã‚ŒãŸã€Œç¨å¾ŒCF(å†…éƒ¨ç•™ä¿)ã€ãŒã‚°ãƒ©ãƒ•ã®ç·‘éƒ¨åˆ†ã«ãªã‚Šã¾ã™</small>
    </div>
    <div class="card-bd">
      <div class="row" style="max-width:300px;margin-bottom:1rem">
        <div class="input-group" style="margin:0">
          <label>å®ŸåŠ¹ç¨ç‡ï¼ˆ%ï¼‰</label>
          <input id="taxRate" type="number" value="30">
        </div>
      </div>

      <div class="tbl-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>é …ç›® (å˜ä½:å††)</th>
              <th>1å¹´ç›®</th>
              <th>2å¹´ç›®</th>
              <th>3å¹´ç›®</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>å£²ä¸Šé«˜</th>
              <td><input class="pl-in" id="s1" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="s2" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="s3" data-fmt placeholder="0"></td>
            </tr>
            <tr>
              <th>å¤‰å‹•è²» (åŸä¾¡ç­‰)</th>
              <td><input class="pl-in" id="v1" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="v2" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="v3" data-fmt placeholder="0"></td>
            </tr>
            <tr>
              <th>å›ºå®šè²» (äººä»¶è²»/å®¶è³ƒç­‰)</th>
              <td><input class="pl-in" id="f1" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="f2" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="f3" data-fmt placeholder="0"></td>
            </tr>
            <tr>
              <th>æ¸›ä¾¡å„Ÿå´è²» (éè³‡é‡‘)</th>
              <td><input class="pl-in" id="d1" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="d2" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="d3" data-fmt placeholder="0"></td>
            </tr>
            <tr style="background:#f8fafc;font-weight:bold;color:var(--sub)">
              <th>ç¨å¼•å‰åˆ©ç›Š (è¨ˆç®—)</th>
              <td id="pbt1">0</td><td id="pbt2">0</td><td id="pbt3">0</td>
            </tr>
            <tr style="color:var(--sub)">
              <th>ç¨é¡ (æ¦‚ç®—)</th>
              <td id="tax1">0</td><td id="tax2">0</td><td id="tax3">0</td>
            </tr>
            <tr>
              <th>ç¨å¼•å¾Œåˆ©ç›Š (è¨ˆç®—)</th>
              <td id="np1">0</td><td id="np2">0</td><td id="np3">0</td>
            </tr>
            <tr>
              <th>è¿”æ¸ˆ/ç”Ÿæ´»è²»/æŠ•è³‡ç­‰ (ï¼)</th>
              <td><input class="pl-in" id="out1" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="out2" data-fmt placeholder="0"></td>
              <td><input class="pl-in" id="out3" data-fmt placeholder="0"></td>
            </tr>
            <tr style="background:#dcfce7;border-top:2px solid var(--primary)">
              <th style="color:var(--primary)">â˜…ç¨å¾ŒCF (å†…éƒ¨ç•™ä¿)</th>
              <td id="fcf1" style="color:var(--primary)">0</td>
              <td id="fcf2" style="color:var(--primary)">0</td>
              <td id="fcf3" style="color:var(--primary)">0</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="font-size:0.8rem;color:var(--sub);margin-top:0.5rem">
        â€»è¨ˆç®—å¼ï¼šç¨å¾ŒCF = ç¨å¼•å¾Œåˆ©ç›Š + æ¸›ä¾¡å„Ÿå´è²» - (è¿”æ¸ˆ/ç”Ÿæ´»è²»/æŠ•è³‡ç­‰)<br>
        â€»ã“ã®ã€Œç¨å¾ŒCFã€ã®3å¹´åˆ†ã‚’æœˆå‰²ã‚Šã—ã€å–å¾—æ™‚æœŸã¾ã§ã®æœˆæ•°åˆ†ã‚’ç©ç«‹é¡ã¨ã—ã¦è¨ˆç®—ã—ã¾ã™ã€‚
      </div>
    </div>
  </section>
</div>

<script>
// Logic Utilities
const el = id => document.getElementById(id);
const fmt = n => isNaN(n) ? "0" : n.toLocaleString('ja-JP');
const yen = n => "Â¥" + fmt(Math.round(n));
const parse = v => {
  if(!v) return 0;
  return parseFloat(String(v).replace(/,/g, '')) || 0;
}

// Data Binding
const inputs = [
  'price','ltv','costRate','months','cashNow','taxRate',
  's1','s2','s3','v1','v2','v3','f1','f2','f3','d1','d2','d3','out1','out2','out3'
];

function init(){
  inputs.forEach(id => {
    const dom = el(id);
    if(!dom) return;
    dom.addEventListener('input', update);
    dom.addEventListener('blur', () => {
      if(dom.dataset.fmt !== undefined) dom.value = fmt(parse(dom.value));
    });
  });
  
  // Chip buttons
  document.querySelectorAll('.chip[data-set]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.set;
      const val = btn.dataset.val;
      const dom = el(id);
      dom.value = dom.dataset.fmt !== undefined ? fmt(Number(val)) : val;
      update();
    });
  });
  
  update();
}

function calcPL(){
  const taxRate = parse(el('taxRate').value) / 100;
  const years = [1,2,3].map(i => {
    const s = parse(el(`s${i}`).value);
    const v = parse(el(`v${i}`).value);
    const f = parse(el(`f${i}`).value);
    const d = parse(el(`d${i}`).value);
    const out = parse(el(`out${i}`).value);

    const pbt = s - v - f - d;
    const tax = Math.max(0, pbt * taxRate);
    const np = pbt - tax;
    const fcf = np + d - out;

    return { s, v, f, d, out, pbt, tax, np, fcf };
  });
  return years;
}

function update(){
  // 1. Basic Inputs
  const price = parse(el('price').value);
  const ltv = parse(el('ltv').value);
  const costRate = parse(el('costRate').value);
  const months = parse(el('months').value);
  const cashNow = parse(el('cashNow').value);
  
  // 2. PL Calculation
  const pl = calcPL();
  
  // Render PL Table
  pl.forEach((y, i) => {
    const idx = i+1;
    el(`pbt${idx}`).innerText = fmt(Math.round(y.pbt));
    el(`tax${idx}`).innerText = fmt(Math.round(y.tax));
    el(`np${idx}`).innerText = fmt(Math.round(y.np));
    el(`fcf${idx}`).innerText = fmt(Math.round(y.fcf));
  });

  // 3. Future Accumulation (Prorated)
  // 3å¹´é–“ã®FCFåˆè¨ˆã‚’36ãƒ¶æœˆã§å‰²ã‚Šã€æŒ‡å®šæœˆæ•°åˆ†ã‚’ç©ã‚€ã‚¤ãƒ¡ãƒ¼ã‚¸
  // (ã‚ˆã‚Šå³å¯†ã«ã¯æœˆã”ã¨ã«ç©ã‚€ãŒã€ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å¹³å‡åŒ–)
  let totalFCF3Years = pl.reduce((acc, y) => acc + y.fcf, 0);
  let avgMonthlyFCF = totalFCF3Years / 36; 
  // ã‚‚ã—3å¹´PLãŒã™ã¹ã¦0ãªã‚‰0
  if(totalFCF3Years === 0) avgMonthlyFCF = 0;
  
  const futureCash = avgMonthlyFCF * months;
  const totalPrepared = cashNow + futureCash;

  // 4. Requirements
  const costs = price * (costRate / 100);
  const totalNeeded = price + costs;
  const loan = price * (ltv / 100);
  const gap = totalNeeded - (loan + totalPrepared);

  // 5. Update Status
  const statusBox = el('statusBox');
  if(price === 0){
    statusBox.className = "status-box";
    el('statusIcon').innerText = "ğŸ”¢";
    el('statusText').innerText = "æ•°å€¤å…¥åŠ›å¾…ã¡";
    el('statusSub').innerText = "ç‰©ä»¶ä¾¡æ ¼ã‚„PLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
  } else if(gap <= 0){
    statusBox.className = "status-box ok";
    el('statusIcon').innerText = "âœ…";
    el('statusText').innerText = "é”æˆå¯èƒ½";
    el('statusSub').innerText = `è¨ˆç”»é€šã‚Šãªã‚‰è³‡é‡‘ã¯è¶³ã‚Šã¾ã™ï¼ˆä½™åŠ› ${yen(Math.abs(gap))}ï¼‰`;
  } else {
    statusBox.className = "status-box ng";
    el('statusIcon').innerText = "âš ï¸";
    el('statusText').innerText = `ä¸è¶³ï¼š${yen(gap)}`;
    el('statusSub').innerText = "PLã‚’è¦‹ç›´ã—ã€åˆ©ç›Š(å†…éƒ¨ç•™ä¿)ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„";
  }

  // 6. Update Bar Chart
  const maxVal = Math.max(totalNeeded, loan + totalPrepared) || 1;
  const pct = v => (v / maxVal) * 100;
  
  el('labelTotal').innerText = yen(totalNeeded);
  el('labelPrep').innerText = yen(loan + totalPrepared);

  el('segLoan').style.width = pct(loan) + "%";
  el('segLoan').innerText = pct(loan)>10 ? `å€Ÿå…¥${yen(loan)}` : "";
  
  el('segNow').style.width = pct(cashNow) + "%";
  el('segNow').innerText = pct(cashNow)>10 ? `ç¾${yen(cashNow)}` : "";
  
  el('segFut').style.width = pct(futureCash) + "%";
  el('segFut').innerText = pct(futureCash)>10 ? `ç©${yen(futureCash)}` : "";
  
  el('segGap').style.width = (gap>0 ? pct(gap) : 0) + "%";

  // 7. Update Line Chart
  const svg = el('lineChart');
  const w = 300, h = 180;
  const maxY = Math.max(totalNeeded - loan, totalPrepared * 1.1, 100000); // å€Ÿå…¥é™¤ã„ãŸå¿…è¦è‡ªå·±è³‡é‡‘ãƒ™ãƒ¼ã‚¹ã§æç”»
  const getY = v => h - ((v / maxY) * h);
  
  // Target Line (Need - Loan)
  const targetVal = Math.max(0, totalNeeded - loan);
  const yT = getY(targetVal);
  const lineT = `<line x1="0" y1="${yT}" x2="${w}" y2="${yT}" class="line-target" />`;
  
  // Plan Line
  const yStart = getY(cashNow);
  const yEnd = getY(totalPrepared);
  const lineP = `<line x1="0" y1="${yStart}" x2="${w}" y2="${yEnd}" class="line-plan" />`;
  const dotP = `<circle cx="${w}" cy="${yEnd}" class="dot" fill="${gap<=0 ? '#15803d':'#ef4444'}" />`;
  
  svg.innerHTML = lineT + lineP + dotP;

  // Date
  const d = new Date();
  d.setMonth(d.getMonth() + months);
  el('targetDate').innerText = `ç›®æ¨™ï¼š${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
}

init();
</script>
</body>
</html>
