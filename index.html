<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï½œr5</title>
  <style>
    :root{
      --bg:#f1f5f9; --card:#fff; --text:#1e293b; --sub:#64748b; --border:#cbd5e1;
      --primary:#0f766e; --primary-light:#ccfbf1;
      --ok:#15803d; --ok-bg:#dcfce7;
      --warn:#b45309; --warn-bg:#fef3c7;
      --danger:#b91c1c; --danger-bg:#fee2e2;
      --radius:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;line-height:1.4}
    
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid-top{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem}
    @media(min-width:900px){.grid-top{grid-template-columns:350px 1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,0.05);overflow:hidden;border:1px solid var(--border);margin-bottom:1rem}
    .card-hd{padding:0.8rem 1rem;border-bottom:1px solid var(--border);background:#f8fafc;display:flex;justify-content:space-between;align-items:center;font-weight:bold;color:var(--text)}
    .card-bd{padding:1.2rem}

    label{display:block;font-size:0.8rem;color:var(--sub);font-weight:bold;margin-bottom:0.3rem}
    input{width:100%;padding:0.6rem;border:1px solid var(--border);border-radius:6px;font-size:1rem;background:#fff;text-align:right;font-variant-numeric:tabular-nums}
    input:focus{outline:2px solid var(--primary);border-color:transparent}
    .input-group{margin-bottom:1rem}
    .row{display:flex;gap:0.8rem}
    .row > *{flex:1}
    
    .chips{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.3rem;justify-content:flex-end}
    .chip{font-size:0.75rem;padding:0.2rem 0.6rem;border:1px solid var(--border);border-radius:99px;background:#fff;cursor:pointer;color:var(--sub)}
    .chip:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}

    /* Dashboard */
    .status-box{padding:1.2rem;text-align:center;border-radius:var(--radius);margin-bottom:1rem;border:2px solid transparent;position:relative;overflow:hidden}
    .status-box.ok{background:var(--ok-bg);border-color:var(--ok);color:var(--ok)}
    .status-box.ng{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
    
    .kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    .kpi-card{background:rgba(255,255,255,0.6);padding:0.8rem;border-radius:8px;text-align:center}
    .kpi-lbl{font-size:0.75rem;opacity:0.8;font-weight:bold;margin-bottom:0.3rem}
    .kpi-val{font-size:1.1rem;font-weight:900}
    .kpi-val.red{color:var(--danger)}

    /* Bar Chart */
    .bar-track{height:2rem;background:#f1f5f9;border-radius:6px;overflow:hidden;display:flex;margin:0.5rem 0}
    .bar-seg{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.7rem;font-weight:bold;white-space:nowrap;overflow:hidden;transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1)}
    .bs-loan{background:#94a3b8} 
    .bs-now{background:#0f766e} 
    .bs-fut{background:#2dd4bf;color:#0f4c3a} 
    .bs-gap{background:#ef4444}

    /* PL Table */
    .tbl-wrap{overflow-x:auto}
    .tbl{width:100%;border-collapse:collapse;font-size:0.9rem;min-width:650px}
    .tbl th,.tbl td{padding:0.6rem;border-bottom:1px solid #e2e8f0;text-align:right}
    .tbl th{text-align:left;color:var(--sub);background:#f8fafc;width:160px;position:sticky;left:0}
    .tbl input{border:1px solid #e2e8f0;background:#fff;width:100%}
    .tbl input:focus{background:#fff;border-color:var(--primary)}
    .tbl tr:last-child td{font-weight:bold;background:#f0fdf4;border-bottom:none;color:var(--primary)}

    /* Action Box */
    .action-box{background:#fff;border:1px dashed var(--warn);border-radius:8px;padding:1rem;margin-top:1rem;font-size:0.9rem}
    .action-title{font-weight:bold;color:var(--warn);display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem}

    @media print{
      .no-print{display:none}
      body{background:#fff}
      .card{border:1px solid #000;box-shadow:none;page-break-inside:avoid}
      .grid-top{display:block}
    }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h1 style="font-size:1.2rem;margin:0">åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span style="font-size:0.8rem;font-weight:normal;color:var(--sub)">r5</span></h1>
    <button class="chip no-print" onclick="window.print()" style="font-weight:bold">ğŸ–¨ å°åˆ· / PDF</button>
  </div>

  <div class="grid-top">
    
    <div class="no-print-break">
      <section class="card">
        <div class="card-hd">1. ç›®æ¨™è¨­å®š</div>
        <div class="card-bd">
          <div class="input-group">
            <label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
            <input id="price" type="text" inputmode="numeric" placeholder="ä¾‹: 80,000,000">
            <div class="chips">
              <button class="chip" data-set="price" data-val="50000000">5,000ä¸‡</button>
              <button class="chip" data-set="price" data-val="80000000">8,000ä¸‡</button>
              <button class="chip" data-set="price" data-val="100000000">1å„„</button>
            </div>
          </div>

          <div class="row">
            <div class="input-group">
              <label>å€Ÿå…¥ (LTV %)</label>
              <input id="ltv" type="number" value="80">
            </div>
            <div class="input-group">
              <label>è«¸è²»ç”¨ (%)</label>
              <input id="costRate" type="number" value="8">
            </div>
          </div>

          <div class="input-group">
            <label>å–å¾—æ™‚æœŸï¼ˆä½•ã‹æœˆå¾Œï¼‰</label>
            <input id="months" type="number" value="36">
            <div style="font-size:0.75rem;color:var(--sub);text-align:right" id="targetDate"></div>
          </div>

          <div class="input-group" style="border-top:1px dashed var(--border);padding-top:1rem">
            <label>ç¾åœ¨ã®è‡ªå·±è³‡é‡‘ï¼ˆå††ï¼‰</label>
            <input id="cashNow" type="text" inputmode="numeric" placeholder="0">
          </div>
        </div>
      </section>
    </div>

    <div>
      <div id="statusBox" class="status-box ng">
        <div style="font-size:2rem;margin-bottom:0.5rem" id="statusIcon">âš ï¸</div>
        <div style="font-weight:900;font-size:1.4rem" id="statusText">è³‡é‡‘ä¸è¶³</div>
        <div style="margin-top:0.5rem">ã‚ã¨ <span id="statusGap" style="font-weight:bold;font-size:1.2rem">0</span> å†† è¶³ã‚Šã¾ã›ã‚“</div>
        
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-lbl">æœˆã‚ãŸã‚Šã®ä¸è¶³é¡</div>
            <div class="kpi-val red" id="monthlyGap">Â¥0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">è³¼å…¥æ™‚ å¿…è¦è‡ªå·±è³‡é‡‘</div>
            <div class="kpi-val" id="needOwn">Â¥0</div>
          </div>
        </div>
      </div>

      <section class="card">
        <div class="card-bd" style="padding-bottom:0.5rem">
          <div style="font-size:0.8rem;display:flex;justify-content:space-between;font-weight:bold">
            <span>å¿…è¦ç·é¡: <span id="labelTotal">0</span></span>
            <span>æº–å‚™å¯èƒ½: <span id="labelPrep">0</span></span>
          </div>
          <div class="bar-track">
            <div id="segLoan" class="bar-seg bs-loan" style="width:0%"></div>
            <div id="segNow" class="bar-seg bs-now" style="width:0%"></div>
            <div id="segFut" class="bar-seg bs-fut" style="width:0%"></div>
            <div id="segGap" class="bar-seg bs-gap" style="width:0%"></div>
          </div>
          <div style="display:flex;gap:0.8rem;flex-wrap:wrap;font-size:0.7rem;color:var(--sub);margin-top:0.5rem">
            <span style="color:#64748b">â– å€Ÿå…¥</span>
            <span style="color:#0f766e">â– ç¾åœ¨è³‡é‡‘</span>
            <span style="color:#2dd4bf;font-weight:bold">â– å°†æ¥ç©ç«‹(PL)</span>
            <span style="color:#ef4444;font-weight:bold">â– ä¸è¶³</span>
          </div>
        </div>
        
        <div class="action-box" id="actionBox" style="margin:0 1rem 1rem 1rem">
          <div class="action-title">ğŸ’¡ ç¤¾é•·ã¸ã®ã”ææ¡ˆï¼ˆé€†ç®—ï¼‰</div>
          <div id="actionMsg">3å¹´PLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å…·ä½“çš„ãªå¯¾ç­–ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </section>
    </div>
  </div>

  <section class="card">
    <div class="card-hd">
      <span>2. äº‹æ¥­è¨ˆç”» (3ã‚«å¹´PL / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼)</span>
      <small style="font-weight:normal;color:var(--sub)">ã“ã“ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚°ãƒ©ãƒ•ã®ç·‘ï¼ˆç©ç«‹ï¼‰ãŒå¢—ãˆã¾ã™</small>
    </div>
    <div class="card-bd">
      <div style="max-width:200px;margin-bottom:1rem">
        <label>å®ŸåŠ¹ç¨ç‡ (%)</label>
        <input id="taxRate" type="number" value="30" style="text-align:right">
      </div>

      <div class="tbl-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>é …ç›® (å††)</th>
              <th>1å¹´ç›®</th>
              <th>2å¹´ç›®</th>
              <th>3å¹´ç›®</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>å£²ä¸Šé«˜</th>
              <td><input class="pl-in" id="s1" inputmode="numeric"></td>
              <td><input class="pl-in" id="s2" inputmode="numeric"></td>
              <td><input class="pl-in" id="s3" inputmode="numeric"></td>
            </tr>
            <tr>
              <th>å¤‰å‹•è²» (åŸä¾¡/åºƒå‘Š)</th>
              <td><input class="pl-in" id="v1" inputmode="numeric"></td>
              <td><input class="pl-in" id="v2" inputmode="numeric"></td>
              <td><input class="pl-in" id="v3" inputmode="numeric"></td>
            </tr>
            <tr>
              <th>å›ºå®šè²» (äººä»¶è²»/å®¶è³ƒ)</th>
              <td><input class="pl-in" id="f1" inputmode="numeric"></td>
              <td><input class="pl-in" id="f2" inputmode="numeric"></td>
              <td><input class="pl-in" id="f3" inputmode="numeric"></td>
            </tr>
            <tr>
              <th>æ¸›ä¾¡å„Ÿå´è²» (éè³‡é‡‘)</th>
              <td><input class="pl-in" id="d1" inputmode="numeric"></td>
              <td><input class="pl-in" id="d2" inputmode="numeric"></td>
              <td><input class="pl-in" id="d3" inputmode="numeric"></td>
            </tr>
            <tr style="background:#f1f5f9;color:var(--sub)">
              <th>ç¨å¼•å‰åˆ©ç›Š</th>
              <td id="pbt1">0</td><td id="pbt2">0</td><td id="pbt3">0</td>
            </tr>
            <tr style="color:var(--sub)">
              <th>ç¨é¡ (æ¦‚ç®—)</th>
              <td id="tax1">0</td><td id="tax2">0</td><td id="tax3">0</td>
            </tr>
            <tr>
              <th>æ—¢å­˜è¿”æ¸ˆ/ç”Ÿæ´»è²» (ï¼)</th>
              <td><input class="pl-in" id="out1" inputmode="numeric" placeholder="å…¬åº«è¿”æ¸ˆç­‰ã¯ã“ã“"></td>
              <td><input class="pl-in" id="out2" inputmode="numeric"></td>
              <td><input class="pl-in" id="out3" inputmode="numeric"></td>
            </tr>
            <tr>
              <th>â˜… ç¨å¾ŒCF (å†…éƒ¨ç•™ä¿)</th>
              <td id="fcf1">0</td><td id="fcf2">0</td><td id="fcf3">0</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
// --- Utils ---
const el = id => document.getElementById(id);
const fmt = n => isNaN(n) ? "0" : n.toLocaleString('ja-JP');
const yen = n => "Â¥" + fmt(Math.round(n));
const parse = v => {
  if(!v) return 0;
  const s = String(v).replace(/,/g, '');
  return parseFloat(s) || 0;
}

// --- Real-time Comma Formatting ---
function attachRealtimeFormat() {
  const inputs = document.querySelectorAll('input[inputmode="numeric"]');
  inputs.forEach(inp => {
    inp.addEventListener('input', (e) => {
      // 1. ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®ä¿æŒï¼ˆç°¡æ˜“ç‰ˆï¼šæœ«å°¾ã«è¡Œãã®ã‚’é˜²ãåŠªåŠ›ã¯ã™ã‚‹ãŒã€ã‚«ãƒ³ãƒå¢—æ¸›ã§ã‚ºãƒ¬ã‚‹ãŸã‚åŸºæœ¬ã¯å†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
      const raw = e.target.value.replace(/,/g, '');
      if(raw === '') return;
      if(isNaN(raw)) {
        e.target.value = ''; 
        update(); 
        return;
      }
      const val = parseFloat(raw);
      e.target.value = val.toLocaleString('ja-JP');
      update();
    });
    // Bluræ™‚ã«å¤‰ãªæ–‡å­—ãŒã‚ã‚Œã°æ¶ˆã™
    inp.addEventListener('blur', (e) => {
      update();
    });
  });
}

// --- Logic ---
function update() {
  // 1. Basic Inputs
  const price = parse(el('price').value);
  const ltv = parse(el('ltv').value);
  const costRate = parse(el('costRate').value);
  const months = Math.max(1, parse(el('months').value));
  const cashNow = parse(el('cashNow').value);
  const taxRate = parse(el('taxRate').value) / 100;

  // 2. PL Calculation
  const pl = [1,2,3].map(i => {
    const s = parse(el(`s${i}`).value);
    const v = parse(el(`v${i}`).value);
    const f = parse(el(`f${i}`).value);
    const d = parse(el(`d${i}`).value);
    const out = parse(el(`out${i}`).value);

    const pbt = s - v - f - d;
    const tax = Math.max(0, pbt * taxRate);
    const np = pbt - tax;
    const fcf = np + d - out;

    return { s, v, f, d, out, pbt, tax, np, fcf };
  });

  // Render PL Results
  pl.forEach((y, i) => {
    const idx = i+1;
    el(`pbt${idx}`).innerText = fmt(Math.round(y.pbt));
    el(`tax${idx}`).innerText = fmt(Math.round(y.tax));
    el(`fcf${idx}`).innerText = fmt(Math.round(y.fcf));
  });

  // 3. Future Cash Logic (3å¹´åˆè¨ˆã‚’æœˆæ•°ã§æŒ‰åˆ†ç©ç«‹ã¨ã¿ãªã™)
  const totalFCF3Years = pl.reduce((acc, y) => acc + y.fcf, 0);
  const avgMonthlyFCF = totalFCF3Years / 36; 
  const futureCash = avgMonthlyFCF * months;
  
  // 4. Totals
  const costs = price * (costRate / 100);
  const totalNeeded = price + costs;
  const loan = price * (ltv / 100);
  
  // å¿…è¦ãªè‡ªå·±è³‡é‡‘ (å€Ÿå…¥ä»¥å¤–ã§ç”¨æ„ã™ã¹ãé‡‘)
  const needOwn = Math.max(0, totalNeeded - loan);
  const totalPrepared = cashNow + futureCash;
  const gap = Math.max(0, needOwn - totalPrepared);
  const monthlyGap = gap / months;

  // 5. Update Dashboard
  const statusBox = el('statusBox');
  const statusText = el('statusText');
  const statusGap = el('statusGap');
  const statusIcon = el('statusIcon');

  if(price === 0) {
    statusBox.className = "status-box";
    statusIcon.innerText = "ğŸ”¢";
    statusText.innerText = "æ•°å€¤ã‚’å…¥åŠ›";
    statusGap.innerText = "0";
    el('monthlyGap').innerText = "â€”";
    el('needOwn').innerText = "â€”";
  } else if(gap <= 0) {
    statusBox.className = "status-box ok";
    statusIcon.innerText = "âœ…";
    statusText.innerText = "é”æˆåœå†…";
    statusGap.innerText = "0";
    el('monthlyGap').innerText = "ä¸è¶³ãªã—";
    el('monthlyGap').style.color = "var(--ok)";
    el('needOwn').innerText = yen(needOwn);
  } else {
    statusBox.className = "status-box ng";
    statusIcon.innerText = "âš ï¸";
    statusText.innerText = "è³‡é‡‘ä¸è¶³";
    statusGap.innerText = fmt(Math.round(gap));
    el('monthlyGap').innerText = yen(monthlyGap);
    el('monthlyGap').style.color = "var(--danger)";
    el('needOwn').innerText = yen(needOwn);
  }

  // Bar Chart
  const maxScale = Math.max(totalNeeded, loan + totalPrepared) || 1;
  el('labelTotal').innerText = yen(totalNeeded);
  el('labelPrep').innerText = yen(loan + totalPrepared);
  
  const pct = v => (v / maxScale) * 100;
  el('segLoan').style.width = pct(loan) + "%";
  el('segLoan').innerText = pct(loan)>10 ? "å€Ÿå…¥" : "";
  el('segNow').style.width = pct(cashNow) + "%";
  el('segNow').innerText = pct(cashNow)>8 ? "ç¾" : "";
  el('segFut').style.width = pct(futureCash) + "%";
  el('segFut').innerText = pct(futureCash)>8 ? "ç©" : "";
  el('segGap').style.width = pct(gap) + "%";

  // Date
  const d = new Date();
  d.setMonth(d.getMonth() + months);
  el('targetDate').innerText = `ç›®æ¨™: ${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;

  // 6. Action Insight (Reverse Engineering)
  // æœˆã‚ãŸã‚Šã®ä¸è¶³é¡ã‚’åŸ‹ã‚ã‚‹ã«ã¯ã€åˆ©ç›Šç‡(ç²—åˆ©-ç¨é‡‘è€ƒæ…®)ã§å‰²ã‚Šæˆ»ã—ã¦å¿…è¦ãªå£²ä¸Šå¢—ã‚’å‡ºã™
  // ç°¡æ˜“çš„ã«ã€Œé™ç•Œåˆ©ç›Šç‡(ç²—åˆ©ç‡)ã€ã§å‰²ã‚Šæˆ»ã™
  const actionBox = el('actionBox');
  const actionMsg = el('actionMsg');
  
  if(gap > 0 && pl[0].s > 0) {
    // ç›´è¿‘(1å¹´ç›®)ã®å¤‰å‹•è²»ç‡ãªã©ã‹ã‚‰ç®—å‡º
    const s1 = pl[0].s;
    const v1 = pl[0].v; // å¤‰å‹•è²»
    const grossMarginRate = s1 > 0 ? (s1 - v1) / s1 : 1; // é™ç•Œåˆ©ç›Šç‡
    const taxEffect = 1 - taxRate;
    
    // å¿…è¦ãªè¿½åŠ ç¨å¼•å‰åˆ©ç›Š = æœˆä¸è¶³é¡ / (1-ç¨ç‡)
    // å¿…è¦ãªè¿½åŠ å£²ä¸Š = å¿…è¦ãªè¿½åŠ ç¨å¼•å‰åˆ©ç›Š / é™ç•Œåˆ©ç›Šç‡
    const neededPBT = monthlyGap / taxEffect;
    const neededSalesMonthly = grossMarginRate > 0 ? neededPBT / grossMarginRate : neededPBT;
    
    actionMsg.innerHTML = `
      ä¸è¶³é¡ï¼ˆæœˆ <b>${yen(monthlyGap)}</b>ï¼‰ã‚’åŸ‹ã‚ã‚‹ãŸã‚ã®ãƒ’ãƒ³ãƒˆï¼š<br>
      ç¾åœ¨ã®åˆ©ç›Šæ§‹é€ ãªã‚‰ã€<span style="color:#b91c1c;font-weight:bold;font-size:1.1rem">æœˆå•†ã‚’ã‚ã¨ ${yen(neededSalesMonthly)} ã‚¢ãƒƒãƒ—</span> 
      ã™ã‚Œã°é”æˆå¯èƒ½ã§ã™ã€‚<br>
      <small style="color:var(--sub)">â€»ç¨é‡‘(${Math.round(taxRate*100)}%)è€ƒæ…®æ¸ˆã€‚ã“ã“ã‚’æ¯æœˆãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚</small>
    `;
    actionBox.style.display = 'block';
  } else if (gap > 0) {
    actionMsg.innerText = "ä¸‹ã®PLï¼ˆå£²ä¸Šã‚„çµŒè²»ï¼‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ä¸è¶³ã‚’åŸ‹ã‚ã‚‹ãŸã‚ã®ã€Œå¿…è¦å£²ä¸Šé«˜ã€ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚";
    actionBox.style.display = 'block';
  } else {
    actionBox.style.display = 'none';
  }
}

// Setup
attachRealtimeFormat();
document.querySelectorAll('.chip').forEach(b => {
  b.addEventListener('click', () => {
    const i = el(b.dataset.set);
    i.value = Number(b.dataset.val).toLocaleString('ja-JP');
    update();
  });
});
document.querySelectorAll('input').forEach(i => i.addEventListener('change', update));

// Init
update();
</script>
</body>
</html>
