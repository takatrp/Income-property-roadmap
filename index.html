<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï½œr3</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#1e293b; --sub:#64748b; --border:#e2e8f0;
      --primary:#0f766e; --primary-light:#ccfbf1;
      --ok:#15803d; --ok-bg:#dcfce7;
      --warn:#b45309; --warn-bg:#fef3c7;
      --danger:#b91c1c; --danger-bg:#fee2e2;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;line-height:1.5}
    
    /* Layout */
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .grid-2{display:grid;grid-template-columns:1fr;gap:1.5rem}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}

    /* Card */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;border:1px solid var(--border)}
    .card-hd{padding:1rem;border-bottom:1px solid var(--border);background:#f1f5f9;display:flex;justify-content:space-between;align-items:center}
    .card-ttl{font-weight:bold;color:var(--text)}
    .card-bd{padding:1.25rem}

    /* Inputs */
    label{display:block;font-size:0.85rem;color:var(--sub);font-weight:bold;margin-bottom:0.4rem}
    input,select{width:100%;padding:0.6rem;border:1px solid var(--border);border-radius:6px;font-size:1rem;background:#fff}
    input:focus{outline:2px solid var(--primary);border-color:transparent}
    .input-group{margin-bottom:1.2rem}
    .row{display:flex;gap:1rem}
    .row > *{flex:1}
    
    /* Chips */
    .chips{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.4rem}
    .chip{font-size:0.8rem;padding:0.2rem 0.6rem;border:1px solid var(--border);border-radius:99px;background:#fff;cursor:pointer;color:var(--sub)}
    .chip:hover{border-color:var(--primary);color:var(--primary)}

    /* Dashboard (Result) */
    .status-box{padding:1.5rem;text-align:center;border-radius:var(--radius);margin-bottom:1.5rem;border:2px solid transparent}
    .status-box.ok{background:var(--ok-bg);border-color:var(--ok);color:var(--ok)}
    .status-box.ng{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
    .status-icon{font-size:2rem;margin-bottom:0.5rem;display:block}
    .status-main{font-size:1.8rem;font-weight:900}
    .status-sub{font-size:1rem;opacity:0.9}

    /* Bar Chart (CSS) */
    .bar-chart-wrap{margin:1.5rem 0}
    .bar-label{display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:0.3rem;font-weight:bold}
    .bar-track{height:2.5rem;background:#f1f5f9;border-radius:8px;overflow:hidden;display:flex;position:relative}
    .bar-seg{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.8rem;font-weight:bold;white-space:nowrap;overflow:hidden}
    .bs-loan{background:#94a3b8} /* å€Ÿå…¥ */
    .bs-now{background:#0f766e} /* è‡ªå·±è³‡é‡‘(ç¾) */
    .bs-fut{background:#2dd4bf;color:#0f4c3a} /* å†…éƒ¨ç•™ä¿ */
    .bs-gap{background:#ef4444;position:relative} /* ä¸è¶³ */
    .bs-gap::after{content:"ä¸è¶³";position:absolute;right:10px;color:#fff;font-size:0.8rem}
    
    /* Line Chart (SVG) */
    .chart-container{position:relative;height:200px;width:100%;margin-top:1rem;border-left:1px solid var(--border);border-bottom:1px solid var(--border)}
    svg{width:100%;height:100%;overflow:visible}
    .line-target{fill:none;stroke:#ef4444;stroke-width:2;stroke-dasharray:4}
    .line-plan{fill:none;stroke:#0f766e;stroke-width:3}
    .dot{fill:#fff;stroke-width:2;r:4}

    /* Tables */
    .tbl{width:100%;border-collapse:collapse;font-size:0.9rem}
    .tbl th,.tbl td{padding:0.6rem;border-bottom:1px solid var(--border);text-align:right}
    .tbl th{text-align:left;color:var(--sub)}
    .tbl tr:last-child td{border-bottom:none}
    
    /* Print */
    @media print{
      .no-print{display:none}
      body{background:#fff}
      .card{border:1px solid #000;box-shadow:none}
      .bar-track{border:1px solid #ccc}
    }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h1 style="font-size:1.4rem;margin:0">åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span style="font-size:0.9rem;font-weight:normal;color:var(--sub)">r3</span></h1>
    <button class="chip no-print" onclick="window.print()" style="font-weight:bold">ğŸ–¨ å°åˆ· / PDF</button>
  </div>

  <div class="grid-2">
    
    <div>
      <section class="card">
        <div class="card-hd"><span class="card-ttl">1. ç›®æ¨™è¨­å®šï¼ˆç‰©ä»¶ãƒ»èè³‡ï¼‰</span></div>
        <div class="card-bd">
          <div class="input-group">
            <label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
            <input id="price" type="text" inputmode="numeric" data-format placeholder="80,000,000">
            <div class="chips">
              <button class="chip" data-set="price" data-val="50000000">5,000ä¸‡</button>
              <button class="chip" data-set="price" data-val="80000000">8,000ä¸‡</button>
              <button class="chip" data-set="price" data-val="100000000">1å„„</button>
            </div>
          </div>

          <div class="row">
            <div class="input-group">
              <label>LTVï¼ˆå€Ÿå…¥å‰²åˆ %ï¼‰</label>
              <input id="ltv" type="number" value="80">
              <div class="chips">
                <button class="chip" data-set="ltv" data-val="80">80%</button>
                <button class="chip" data-set="ltv" data-val="90">90%</button>
              </div>
            </div>
            <div class="input-group">
              <label>è«¸è²»ç”¨ï¼ˆæ¦‚ç®— %ï¼‰</label>
              <input id="costRate" type="number" value="8">
              <div class="chips">
                <button class="chip" data-set="costRate" data-val="7">7%</button>
                <button class="chip" data-set="costRate" data-val="10">10%</button>
              </div>
            </div>
          </div>

          <div class="input-group">
            <label>å–å¾—æ™‚æœŸï¼ˆä½•ã‹æœˆå¾Œï¼‰</label>
            <input id="months" type="number" value="36">
            <div style="font-size:0.8rem;color:var(--sub);margin-top:4px">
              ç›®æ¨™ï¼š<span id="targetDate"></span>
            </div>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:1.5rem">
        <div class="card-hd">
          <span class="card-ttl">2. è²¡å‹™ä½“åŠ›ï¼ˆç¾åœ¨ã¨æœªæ¥ï¼‰</span>
          <small style="color:var(--sub)">â€»TKCå·¡å›ç›£æŸ»ã«ã‚ˆã‚‹è¨ˆç”»å€¤</small>
        </div>
        <div class="card-bd">
          <div class="input-group">
            <label>ç¾åœ¨ã®è‡ªå·±è³‡é‡‘ï¼ˆå††ï¼‰</label>
            <input id="cashNow" type="text" inputmode="numeric" data-format placeholder="5,000,000">
          </div>

          <div style="background:#f8fafc;padding:1rem;border-radius:8px;border:1px dashed var(--border)">
            <label style="color:#0f766e">ä»Šå¾Œ3å¹´é–“ã®å†…éƒ¨ç•™ä¿ï¼ˆå¹´é–“ å¹³å‡ï¼‰</label>
            <div class="row">
              <div class="input-group" style="margin-bottom:0">
                <input id="profitYear" type="text" inputmode="numeric" data-format placeholder="ä¾‹ï¼š2,000,000">
              </div>
            </div>
            <div style="font-size:0.8rem;color:var(--sub);margin-top:0.5rem;line-height:1.4">
              â€»ç¨å¼•å¾Œåˆ©ç›Šï¼‹æ¸›ä¾¡å„Ÿå´è²»ï¼è¿”æ¸ˆ(ç´„å®š)ï¼ç”Ÿæ´»è²»ç­‰ã®å®Ÿè³ªæ‰‹æ®‹ã‚Šã€‚<br>
              <strong>ã€Œã“ã®é¡ã‚’æ¯å¹´è²¯ã‚ã‚‹ã€</strong>ã¨ã„ã†è¨ˆç”»å€¤ã‚’å…¥åŠ›ã€‚
            </div>
          </div>
          
          <div class="chips" style="margin-top:1rem">
             <span style="font-size:0.8rem;color:var(--sub)">ç°¡æ˜“å…¥åŠ›ï¼š</span>
             <button class="chip" data-set="profitYear" data-val="1000000">å¹´100ä¸‡</button>
             <button class="chip" data-set="profitYear" data-val="3000000">å¹´300ä¸‡</button>
             <button class="chip" data-set="profitYear" data-val="5000000">å¹´500ä¸‡</button>
          </div>
        </div>
      </section>
    </div>

    <div>
      <div id="statusBox" class="status-box ng">
        <span class="status-icon" id="statusIcon">âš ï¸</span>
        <div class="status-main" id="statusText">åˆ¤å®šä¸èƒ½</div>
        <div class="status-sub" id="statusSub">æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <section class="card">
        <div class="card-hd"><span class="card-ttl">è³‡é‡‘èª¿é”æ§‹æˆãƒãƒ£ãƒ¼ãƒˆ</span></div>
        <div class="card-bd">
          
          <div class="bar-chart-wrap">
            <div class="bar-label">
              <span>å¿…è¦ç·é¡</span>
              <span id="labelTotal">Â¥0</span>
            </div>
            <div class="bar-track" style="margin-bottom:1rem;background:#e2e8f0">
               <div style="width:100%;background:#64748b;color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.8rem">
                 å¿…è¦è³‡é‡‘ç·é¡ (100%)
               </div>
            </div>

            <div class="bar-label">
              <span>æº–å‚™çŠ¶æ³ï¼ˆå†…è¨³ï¼‰</span>
              <span id="labelPrep">Â¥0</span>
            </div>
            <div class="bar-track" id="barTrack">
              <div id="segLoan" class="bar-seg bs-loan" style="width:0%">å€Ÿå…¥</div>
              <div id="segNow" class="bar-seg bs-now" style="width:0%">è‡ªå·±è³‡é‡‘</div>
              <div id="segFut" class="bar-seg bs-fut" style="width:0%">ç©ç«‹</div>
              <div id="segGap" class="bar-seg bs-gap" style="width:0%"></div>
            </div>
            
            <div style="display:flex;gap:1rem;flex-wrap:wrap;font-size:0.75rem;margin-top:0.5rem;color:var(--sub)">
              <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#94a3b8;border-radius:2px"></span>å€Ÿå…¥å¯èƒ½é¡</div>
              <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#0f766e;border-radius:2px"></span>ç¾åœ¨è³‡é‡‘</div>
              <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#2dd4bf;border-radius:2px"></span>å°†æ¥ç©ç«‹(è¨ˆç”»)</div>
              <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#ef4444;border-radius:2px"></span>ä¸è¶³</div>
            </div>
          </div>

          <div style="margin-top:2rem">
            <div class="card-ttl" style="font-size:0.95rem">è‡ªå·±è³‡é‡‘ã®æ¨ç§»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
            <div class="chart-container">
              <svg id="lineChart" viewBox="0 0 300 200" preserveAspectRatio="none">
                </svg>
              <div style="position:absolute;bottom:-20px;left:0;font-size:0.7rem;color:var(--sub)">ç¾åœ¨</div>
              <div style="position:absolute;bottom:-20px;right:0;font-size:0.7rem;color:var(--sub)" id="labelEndParams">3å¹´å¾Œ</div>
              <div style="position:absolute;top:0;right:5px;font-size:0.7rem;color:#ef4444;font-weight:bold">å¿…è¦é¡</div>
            </div>
             <div style="font-size:0.8rem;text-align:right;color:var(--sub);margin-top:1.5rem">
               ç·‘ã®å®Ÿç·šãŒç›®æ¨™é¡ï¼ˆèµ¤ç‚¹ç·šï¼‰ã«å±Šã‹ãªã‘ã‚Œã°è³¼å…¥ä¸å¯
             </div>
          </div>

        </div>
      </section>

      <section class="card" style="margin-top:1.5rem">
        <div class="card-hd"><span class="card-ttl">è©³ç´°æ•°å€¤ï¼ˆæ¦‚ç®—ï¼‰</span></div>
        <div class="card-bd">
          <table class="tbl">
            <tr><th>ç‰©ä»¶ä¾¡æ ¼</th><td id="valPrice">Â¥0</td></tr>
            <tr><th>ï¼‹ è«¸è²»ç”¨</th><td id="valCost">Â¥0</td></tr>
            <tr style="background:#f8fafc"><th>ï¼ å¿…è¦ç·é¡</th><td id="valTotal" style="font-weight:bold">Â¥0</td></tr>
            <tr><th>ï¼ å€Ÿå…¥å¯èƒ½é¡ (LTV)</th><td id="valLoan">â–² Â¥0</td></tr>
            <tr><th>ï¼ ç¾åœ¨ã®è‡ªå·±è³‡é‡‘</th><td id="valNow">â–² Â¥0</td></tr>
            <tr><th>ï¼ å°†æ¥ã®ç©ç«‹ (Ã—æœˆæ•°)</th><td id="valFut">â–² Â¥0</td></tr>
            <tr style="border-top:2px solid var(--border)">
              <th style="color:var(--text);font-weight:900">åˆ¤å®šçµæœï¼ˆä¸è¶³é¡ï¼‰</th>
              <td id="valGap" style="font-weight:900;font-size:1.1rem">Â¥0</td>
            </tr>
          </table>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
// Logic
const el = id => document.getElementById(id);
const fmt = n => isNaN(n) ? "0" : n.toLocaleString('ja-JP');
const yen = n => "Â¥" + fmt(Math.round(n));
const parse = v => {
  if(!v) return 0;
  return parseFloat(String(v).replace(/,/g, '')) || 0;
}

// Inputs
const inputs = ['price','ltv','costRate','months','cashNow','profitYear'];

// Event Listeners
inputs.forEach(id => {
  const dom = el(id);
  dom.addEventListener('input', update);
  dom.addEventListener('blur', () => {
    // Format on blur if it's a number field
    if(dom.dataset.format !== undefined) {
      dom.value = fmt(parse(dom.value));
    }
  });
});

// Chips
document.querySelectorAll('.chip[data-set]').forEach(btn => {
  btn.addEventListener('click', e => {
    const id = btn.dataset.set;
    const val = btn.dataset.val;
    const dom = el(id);
    dom.value = dom.dataset.format !== undefined ? fmt(Number(val)) : val;
    update();
  });
});

// Main Update Function
function update() {
  // 1. Get Values
  const price = parse(el('price').value);
  const ltv = parse(el('ltv').value);
  const costRate = parse(el('costRate').value);
  const months = parse(el('months').value);
  const cashNow = parse(el('cashNow').value);
  const profitYear = parse(el('profitYear').value);

  // 2. Calc Basics
  const costs = price * (costRate / 100);
  const totalNeeded = price + costs;
  
  const loan = price * (ltv / 100);
  const ownFundsNeeded = totalNeeded - loan; // ç´”ç²‹ã«ç¾é‡‘ã§ç”¨æ„ã™ã¹ãé¡
  
  // Future Accumulation
  const profitMonth = profitYear / 12;
  const futureCash = profitMonth * months;
  const totalPrepared = cashNow + futureCash;
  
  const totalReadyFunds = loan + totalPrepared;
  const gap = totalNeeded - totalReadyFunds; // Positive means Shortfall

  // 3. Update Dashboard
  const statusBox = el('statusBox');
  const statusIcon = el('statusIcon');
  const statusText = el('statusText');
  const statusSub = el('statusSub');

  if(price === 0) {
    statusBox.className = "status-box";
    statusIcon.innerText = "ğŸ”¢";
    statusText.innerText = "æ•°å€¤å…¥åŠ›å¾…ã¡";
    statusSub.innerText = "å·¦å´ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
  } else if(gap <= 0) {
    statusBox.className = "status-box ok";
    statusIcon.innerText = "âœ…";
    statusText.innerText = "è³¼å…¥å¯èƒ½åœå†…";
    statusSub.innerText = `ç´ æ™´ã‚‰ã—ã„è¨ˆç”»ã§ã™ã€‚è³‡é‡‘ä½™åŠ›ï¼š${yen(Math.abs(gap))}`;
  } else {
    statusBox.className = "status-box ng";
    statusIcon.innerText = "âš ï¸";
    statusText.innerText = `è³‡é‡‘ä¸è¶³ï¼š${yen(gap)}`;
    statusSub.innerText = `ä»Šã®ãƒšãƒ¼ã‚¹ã§ã¯è¶³ã‚Šã¾ã›ã‚“ã€‚æœˆé¡ã‚ã¨ ${yen(gap/months)} ã®ç©ç«‹ä¸Šä¹—ã›ãŒå¿…è¦ã§ã™ã€‚`;
  }

  // 4. Update Bar Chart (Stacked)
  // Base is totalNeeded. If totalReadyFunds > totalNeeded, we scale down or clip?
  // Let's make the width based on Max(totalNeeded, totalReadyFunds) to avoid overflow
  const maxScale = Math.max(totalNeeded, totalReadyFunds) || 1;
  
  const pctLoan = (loan / maxScale) * 100;
  const pctNow = (cashNow / maxScale) * 100;
  const pctFut = (futureCash / maxScale) * 100;
  const pctGap = (gap > 0) ? (gap / maxScale) * 100 : 0;

  el('labelTotal').innerText = yen(totalNeeded);
  el('labelPrep').innerText = yen(totalReadyFunds);

  el('segLoan').style.width = pctLoan + "%";
  el('segLoan').innerText = pctLoan > 15 ? `å€Ÿå…¥ ${yen(loan)}` : "";

  el('segNow').style.width = pctNow + "%";
  el('segNow').innerText = pctNow > 10 ? `ç¾ ${yen(cashNow)}` : "";

  el('segFut').style.width = pctFut + "%";
  el('segFut').innerText = pctFut > 10 ? `ç© ${yen(futureCash)}` : "";

  el('segGap').style.width = pctGap + "%";
  // gap text handled by css pseudo element or empty

  // 5. Update Line Chart (SVG)
  // X axis: 0 to months
  // Y axis: 0 to ownFundsNeeded (Target)
  // Line 1 (Target): Horizontal dashed line at ownFundsNeeded? No, we need total capital available vs needed cash portion?
  // Let's track "Cash Available" vs "Cash Needed".
  // Cash Needed = Total Cost - Loan. This is static target.
  
  const svg = el('lineChart');
  const w = 300; 
  const h = 200;
  const pad = 20;
  
  // Y-Scale Max
  const maxY = Math.max(ownFundsNeeded, totalPrepared * 1.2, 100000); 
  
  const getY = val => h - ((val / maxY) * h);
  const getX = m => (m / months) * w;

  // Target Line (Need Cash)
  const targetY = getY(ownFundsNeeded);
  // Path: (0, targetY) -> (w, targetY)
  const pathTarget = `<line x1="0" y1="${targetY}" x2="${w}" y2="${targetY}" class="line-target" stroke="#ef4444" stroke-dasharray="4"/>`;
  
  // Accumulation Line
  // Start: cashNow
  // End: totalPrepared
  const startY = getY(cashNow);
  const endY = getY(totalPrepared);
  const pathPlan = `<polyline points="0,${startY} ${w},${endY}" class="line-plan" stroke="#0f766e" fill="none" stroke-width="3"/>`;
  
  // End Dot
  const dotPlan = `<circle cx="${w}" cy="${endY}" class="dot" fill="${gap<=0?'#15803d':'#ef4444'}" stroke="#fff"/>`;

  svg.innerHTML = pathTarget + pathPlan + dotPlan;

  // 6. Update Table
  el('valPrice').innerText = yen(price);
  el('valCost').innerText = yen(costs);
  el('valTotal').innerText = yen(totalNeeded);
  el('valLoan').innerText = "â–² " + yen(loan);
  el('valNow').innerText = "â–² " + yen(cashNow);
  el('valFut').innerText = "â–² " + yen(futureCash);
  el('valGap').innerText = yen(gap);
  el('valGap').style.color = gap > 0 ? "var(--danger)" : "var(--ok)";
  
  // Date target
  const d = new Date();
  d.setMonth(d.getMonth() + months);
  el('targetDate').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ é ƒ`;
}

// Init
update();
</script>
</body>
</html>
