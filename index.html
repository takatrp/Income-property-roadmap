<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï½œr11</title>
  <style>
    :root{
      --bg:#f1f5f9; --card:#fff; --text:#0f172a; --sub:#64748b; --border:#cbd5e1;
      --primary:#0f766e; --primary-light:#ccfbf1;
      --ok:#166534; --ok-bg:#dcfce7;
      --warn:#b45309; --warn-bg:#fffbeb;
      --danger:#991b1b; --danger-bg:#fee2e2;
      --radius:8px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;line-height:1.4;font-size:15px}
    
    /* Layout Wrapper */
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    
    /* Grid System */
    .grid-inputs{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem}
    .grid-dashboard{display:grid;grid-template-columns:1fr;gap:1rem}
    
    /* Desktop Adjustments */
    @media(min-width:900px){
      .grid-inputs{grid-template-columns:1fr 1fr} /* Inputs side-by-side */
      .grid-dashboard{grid-template-columns:350px 1fr} /* Status Left, Charts Right */
    }

    /* Cards */
    .card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;height:100%}
    .card-hd{padding:0.6rem 1rem;border-bottom:1px solid var(--border);background:#f8fafc;display:flex;justify-content:space-between;align-items:center;font-weight:bold;font-size:0.95rem;color:var(--text)}
    .card-bd{padding:1rem}

    /* Inputs */
    label{display:block;font-size:0.75rem;color:var(--sub);font-weight:bold;margin-bottom:0.2rem}
    input{width:100%;padding:0.5rem;border:1px solid var(--border);border-radius:4px;font-size:0.95rem;background:#fff;text-align:right;font-variant-numeric:tabular-nums}
    input:focus{outline:2px solid var(--primary);border-color:var(--primary)}
    .input-group{margin-bottom:0.8rem}
    .row{display:flex;gap:0.8rem}
    .row > *{flex:1}
    
    /* Buttons */
    .chip{font-size:0.75rem;padding:0.3rem 0.8rem;border:1px solid var(--border);border-radius:4px;background:#fff;cursor:pointer;color:var(--sub);font-weight:bold}
    .chip:hover{border-color:var(--primary);color:var(--primary)}
    .btn-reset{font-size:0.75rem;padding:0.3rem 0.8rem;border:1px solid var(--border);border-radius:4px;background:#fff;cursor:pointer;color:var(--sub);margin-left:0.5rem;font-weight:bold}
    .btn-reset:hover{background:#fee2e2;color:#991b1b;border-color:#fee2e2}

    /* Dashboard: Status Box */
    .status-box{padding:1rem;border-radius:var(--radius);border:1px solid transparent;margin-bottom:1rem;height:100%}
    .status-box.ok{background:var(--ok-bg);border-color:var(--ok);color:var(--ok)}
    .status-box.ng{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
    
    .status-main{text-align:center;margin-bottom:1rem}
    .status-icon{font-size:2rem;display:block;margin-bottom:0.2rem}
    .status-text{font-size:1.4rem;font-weight:900}
    .status-gap-text{font-size:0.95rem;opacity:0.9}

    .kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem}
    .kpi-card{background:rgba(255,255,255,0.6);padding:0.5rem;border-radius:6px;text-align:center}
    .kpi-lbl{font-size:0.7rem;font-weight:bold;opacity:0.8}
    .kpi-val{font-size:1rem;font-weight:900}

    /* Dashboard: Insight (Reverse Calc) */
    .insight-box{background:#fff;border:1px dashed var(--warn);border-radius:var(--radius);padding:0.8rem;margin-top:1rem;display:none}
    .insight-row{display:flex;align-items:center;gap:0.4rem;color:#92400e;font-size:0.9rem;justify-content:center}
    .insight-val{font-weight:900;color:#b45309;font-size:1.1rem}

    /* Dashboard: Charts Area */
    .bar-track{height:2rem;background:#f1f5f9;border-radius:4px;overflow:hidden;display:flex;margin:0.5rem 0;border:1px solid #e2e8f0}
    .bar-seg{height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.75rem;font-weight:bold;white-space:nowrap;overflow:hidden;transition:width 0.6s}
    .bs-loan{background:#94a3b8} 
    .bs-now{background:#0f766e} 
    .bs-fut{background:#2dd4bf;color:#0f4c3a} 
    .bs-gap{background:#ef4444}
    
    .chart-container{position:relative;height:160px;width:100%;margin-top:1.5rem;border-left:1px solid var(--border);border-bottom:1px solid var(--border)}
    svg{width:100%;height:100%;overflow:visible}
    .line-target{stroke:#ef4444;stroke-width:2;stroke-dasharray:4}
    .line-plan{stroke:#0f766e;stroke-width:3;fill:none}
    .dot{stroke-width:2;r:4;fill:#fff}

    /* PL Table */
    .tbl{width:100%;border-collapse:collapse;font-size:0.85rem}
    .tbl th,.tbl td{padding:0.5rem;border-bottom:1px solid #f1f5f9;text-align:right}
    .tbl th{text-align:left;color:var(--sub);width:60%;padding-left:0.5rem}
    .tbl tr:last-child td{font-weight:bold;color:var(--primary);border-bottom:none}
    .tbl input{padding:0.3rem}

    @media print{
      .no-print{display:none}
      body{background:#fff}
      .card{border:1px solid #000;box-shadow:none;page-break-inside:avoid}
      .grid-inputs, .grid-dashboard{display:block}
      .status-box{border:1px solid #000;color:#000;background:#fff!important}
    }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
    <h1 style="font-size:1.2rem;margin:0;font-weight:800;color:var(--primary)">åç›Šä¸å‹•ç”£ å–å¾—è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span style="font-size:0.8rem;font-weight:normal;color:var(--sub)">r11</span></h1>
    <div class="no-print">
      <button class="chip" onclick="window.print()">ğŸ–¨ å°åˆ·/PDF</button>
      <button class="btn-reset" id="btnReset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div class="grid-inputs">
    
    <section class="card">
      <div class="card-hd">1. ç›®æ¨™è¨­å®š</div>
      <div class="card-bd">
        <div class="input-group">
          <label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
          <input id="price" type="text" inputmode="numeric" placeholder="ä¾‹: 80,000,000">
        </div>

        <div class="row">
          <div class="input-group">
            <label>LTV (%)</label>
            <input id="ltv" type="number" value="80">
          </div>
          <div class="input-group">
            <label>è«¸è²»ç”¨ (%)</label>
            <input id="costRate" type="number" value="8">
          </div>
        </div>

        <div class="input-group">
          <label>å–å¾—æ™‚æœŸï¼ˆæœˆå¾Œï¼‰</label>
          <input id="months" type="number" value="36">
          <div style="font-size:0.7rem;color:var(--sub);text-align:right" id="targetDate"></div>
        </div>

        <div class="input-group" style="border-top:1px dashed var(--border);padding-top:0.8rem;margin-top:0.8rem">
          <label>ç¾åœ¨ã®è‡ªå·±è³‡é‡‘ï¼ˆå††ï¼‰</label>
          <input id="cashNow" type="text" inputmode="numeric" placeholder="0">
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-hd">
        <span>2. ç›´è¿‘ã®PLï¼ˆ1æœŸåˆ†ï¼‰</span>
        <span style="font-size:0.75rem;font-weight:normal">å°†æ¥ã®ç©ç«‹åŸè³‡ã‚’è©¦ç®—</span>
      </div>
      <div class="card-bd" style="padding:0.5rem 1rem">
        <div style="margin-bottom:0.5rem;text-align:right">
          <label style="display:inline;margin-right:0.5rem">å®ŸåŠ¹ç¨ç‡</label>
          <input id="taxRate" type="number" value="30" style="width:60px;padding:0.2rem;text-align:center">%
        </div>

        <table class="tbl">
          <tr>
            <th>å£²ä¸Šé«˜</th>
            <td><input class="pl-in" id="s1" inputmode="numeric"></td>
          </tr>
          <tr>
            <th>å¤‰å‹•è²»</th>
            <td><input class="pl-in" id="v1" inputmode="numeric"></td>
          </tr>
          <tr>
            <th>å›ºå®šè²»</th>
            <td><input class="pl-in" id="f1" inputmode="numeric"></td>
          </tr>
          <tr>
            <th>æ¸›ä¾¡å„Ÿå´(éè³‡é‡‘)</th>
            <td><input class="pl-in" id="d1" inputmode="numeric"></td>
          </tr>
          <tr style="background:#f8fafc;color:var(--sub)">
            <th>ç¨å¼•å‰åˆ©ç›Š</th>
            <td id="pbt1">0</td>
          </tr>
          <tr style="color:var(--sub)">
            <th>ç¨é¡(æ¦‚ç®—)</th>
            <td id="tax1">0</td>
          </tr>
          <tr>
            <th>å€Ÿå…¥è¿”æ¸ˆ (å…ƒé‡‘)</th>
            <td><input class="pl-in" id="out1" inputmode="numeric" placeholder="å…¬åº«è¿”æ¸ˆç­‰"></td>
          </tr>
          <tr style="border-top:2px solid var(--primary);background:#f0fdf4">
            <th>â˜… ç¨å¾ŒCF(å†…éƒ¨ç•™ä¿)</th>
            <td id="fcf1">0</td>
          </tr>
        </table>
      </div>
    </section>
  </div>

  <div class="grid-dashboard">
    
    <div style="display:flex;flex-direction:column">
      <div id="statusBox" class="status-box ng">
        <div class="status-main">
          <span class="status-icon" id="statusIcon">âš ï¸</span>
          <div class="status-text" id="statusText">è³‡é‡‘ä¸è¶³</div>
          <div class="status-gap-text">ã‚ã¨ <span id="statusGap" style="font-weight:bold">0</span> å†† è¶³ã‚Šã¾ã›ã‚“</div>
        </div>
        
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-lbl">æœˆã‚ãŸã‚Šä¸è¶³</div>
            <div class="kpi-val" id="monthlyGap">Â¥0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">å¿…è¦è‡ªå·±è³‡é‡‘</div>
            <div class="kpi-val" id="needOwn">Â¥0</div>
          </div>
        </div>

        <div id="insightBox" class="insight-box">
          <div class="insight-row">
            <span>ğŸ’¡ æœˆå•†ã‚’ã‚ã¨</span>
            <span class="insight-val" id="neededSales">Â¥0</span>
            <span>UP</span>
          </div>
          <div style="font-size:0.7rem;color:var(--sub);text-align:center;margin-top:0.2rem">
            (ç¾åœ¨ã®åˆ©ç›Šç‡ã‹ã‚‰é€†ç®—)
          </div>
        </div>
      </div>
    </div>

    <section class="card">
      <div class="card-hd">
        <span>è³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        <span style="font-weight:normal;font-size:0.8rem">å¿…è¦ç·é¡: <span id="labelTotal">0</span></span>
      </div>
      <div class="card-bd">
        <div style="font-size:0.75rem;color:var(--sub);margin-bottom:0.2rem">èª¿é”æ§‹æˆ</div>
        <div class="bar-track">
          <div id="segLoan" class="bar-seg bs-loan" style="width:0%"></div>
          <div id="segNow" class="bar-seg bs-now" style="width:0%"></div>
          <div id="segFut" class="bar-seg bs-fut" style="width:0%"></div>
          <div id="segGap" class="bar-seg bs-gap" style="width:0%"></div>
        </div>
        <div style="display:flex;gap:0.8rem;flex-wrap:wrap;font-size:0.7rem;color:var(--sub);margin-top:0.3rem">
          <span style="color:#64748b">â– å€Ÿå…¥</span>
          <span style="color:#0f766e">â– ç¾è³‡é‡‘</span>
          <span style="color:#2dd4bf;font-weight:bold">â– PLç©ç«‹</span>
          <span style="color:#ef4444;font-weight:bold">â– ä¸è¶³</span>
        </div>

        <div class="chart-container">
          <svg id="lineChart" viewBox="0 0 400 160" preserveAspectRatio="none"></svg>
          <div style="position:absolute;top:-5px;right:0;font-size:0.7rem;color:#ef4444;font-weight:bold">å¿…è¦é¡</div>
          <div style="position:absolute;bottom:-20px;left:0;font-size:0.7rem;color:var(--sub)">ç¾åœ¨</div>
          <div style="position:absolute;bottom:-20px;right:0;font-size:0.7rem;color:var(--sub)" id="labelChartEnd">3å¹´å¾Œ</div>
        </div>
        <div style="font-size:0.7rem;color:var(--sub);text-align:right;margin-top:1.5rem">
          ç·‘ã®å®Ÿç·šãŒç›®æ¨™ï¼ˆèµ¤ç‚¹ç·šï¼‰ã«å±Šãã‚ˆã†PLã‚’æ”¹å–„ã—ã¾ã—ã‚‡ã†
        </div>
      </div>
    </section>
  </div>
</div>

<script>
// --- Utils ---
const el = id => document.getElementById(id);
const fmt = n => isNaN(n) ? "0" : n.toLocaleString('ja-JP');
const yen = n => "Â¥" + fmt(Math.round(n));
const parse = v => {
  if(!v) return 0;
  const s = String(v).replace(/,/g, '');
  return parseFloat(s) || 0;
}

// --- Logic ---
function update() {
  // 1. Basic Inputs
  const price = parse(el('price').value);
  const ltv = parse(el('ltv').value);
  const costRate = parse(el('costRate').value);
  const months = Math.max(1, parse(el('months').value));
  const cashNow = parse(el('cashNow').value);
  const taxRate = parse(el('taxRate').value) / 100;

  // 2. PL Calculation (Single Year)
  const s1 = parse(el('s1').value);
  const v1 = parse(el('v1').value);
  const f1 = parse(el('f1').value);
  const d1 = parse(el('d1').value);
  const out1 = parse(el('out1').value);

  const pbt = s1 - v1 - f1 - d1;
  const tax = Math.max(0, pbt * taxRate);
  const np = pbt - tax;
  const fcf = np + d1 - out1; // Annual FCF

  el('pbt1').innerText = fmt(Math.round(pbt));
  el('tax1').innerText = fmt(Math.round(tax));
  el('fcf1').innerText = fmt(Math.round(fcf));

  // 3. Future Cash Projection
  const monthlyFCF = fcf / 12;
  const futureCash = monthlyFCF * months;
  
  // 4. Totals & Gap
  const costs = price * (costRate / 100);
  const totalNeeded = price + costs;
  const loan = price * (ltv / 100);
  
  const needOwn = Math.max(0, totalNeeded - loan);
  const totalPrepared = cashNow + futureCash;
  const gap = Math.max(0, needOwn - totalPrepared);
  const monthlyGap = gap / months;

  // 5. Update Status
  const statusBox = el('statusBox');
  const statusGap = el('statusGap');
  
  if(price === 0) {
    statusBox.className = "status-box";
    el('statusIcon').innerText = "ğŸ”¢";
    el('statusText').innerText = "æ•°å€¤ã‚’å…¥åŠ›";
    statusGap.innerText = "0";
    el('monthlyGap').innerText = "â€”";
    el('needOwn').innerText = "â€”";
  } else if(gap <= 0) {
    statusBox.className = "status-box ok";
    el('statusIcon').innerText = "âœ…";
    el('statusText').innerText = "é”æˆå¯èƒ½";
    statusGap.innerText = "0";
    el('monthlyGap').innerText = "ä¸è¶³ãªã—";
    el('needOwn').innerText = yen(needOwn);
  } else {
    statusBox.className = "status-box ng";
    el('statusIcon').innerText = "âš ï¸";
    el('statusText').innerText = "è³‡é‡‘ä¸è¶³";
    statusGap.innerText = fmt(Math.round(gap));
    el('monthlyGap').innerText = yen(monthlyGap);
    el('needOwn').innerText = yen(needOwn);
  }

  // 6. Action Insight (Reverse Calc)
  const insightBox = el('insightBox');
  if(gap > 0 && s1 > 0){
    const marginRate = (s1 - v1) / s1; 
    if(marginRate > 0){
      const taxEffect = 1 - taxRate;
      const neededPBT = monthlyGap / taxEffect;
      const neededSales = neededPBT / marginRate;
      el('neededSales').innerText = yen(neededSales);
      insightBox.style.display = 'block';
    } else {
      insightBox.style.display = 'none';
    }
  } else {
    insightBox.style.display = 'none';
  }

  // 7. Bar Chart
  const maxScale = Math.max(totalNeeded, loan + totalPrepared) || 1;
  el('labelTotal').innerText = yen(totalNeeded);
  
  const pct = v => (v / maxScale) * 100;
  el('segLoan').style.width = pct(loan) + "%";
  el('segLoan').innerText = pct(loan)>10 ? "å€Ÿ" : "";
  el('segNow').style.width = pct(cashNow) + "%";
  el('segNow').innerText = pct(cashNow)>8 ? "ç¾" : "";
  el('segFut').style.width = pct(futureCash) + "%";
  el('segFut').innerText = pct(futureCash)>8 ? "ç©" : "";
  el('segGap').style.width = pct(gap) + "%";

  // 8. Line Chart (SVG)
  const svg = el('lineChart');
  const w = 400, h = 160;
  const targetVal = needOwn; 
  const preparedVal = totalPrepared;
  const maxY = Math.max(targetVal, preparedVal) * 1.2 || 100000;
  const getY = v => h - ((v / maxY) * h);
  
  const yTarget = getY(targetVal);
  const lineT = `<line x1="0" y1="${yTarget}" x2="${w}" y2="${yTarget}" class="line-target" />`;
  
  const yStart = getY(cashNow);
  const yEnd = getY(preparedVal);
  const lineP = `<line x1="0" y1="${yStart}" x2="${w}" y2="${yEnd}" class="line-plan" />`;
  
  const dotStart = `<circle cx="0" cy="${yStart}" class="dot" stroke="${gap<=0?'#166534':'#0f766e'}" />`;
  const dotEnd = `<circle cx="${w}" cy="${yEnd}" class="dot" stroke="${gap<=0?'#166534':'#991b1b'}" />`;

  svg.innerHTML = lineT + lineP + dotStart + dotEnd;
  
  const d = new Date();
  d.setMonth(d.getMonth() + months);
  el('targetDate').innerText = `ç›®æ¨™: ${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
  el('labelChartEnd').innerText = `${months}ãƒ¶æœˆå¾Œ`;
}

function reset(){
  if(!confirm("å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  document.querySelectorAll('input').forEach(i => i.value = "");
  el('ltv').value = "80";
  el('costRate').value = "8";
  el('months').value = "36";
  el('taxRate').value = "30";
  update();
}

// Setup
const inputs = document.querySelectorAll('input[inputmode="numeric"], input[type="text"]');
inputs.forEach(inp => {
  inp.addEventListener('input', (e) => {
    const raw = e.target.value.replace(/,/g, '');
    if(raw === '') { update(); return; }
    if(isNaN(raw)) { e.target.value = ''; update(); return; }
    e.target.value = parseFloat(raw).toLocaleString('ja-JP');
    update();
  });
  inp.addEventListener('blur', update);
});
document.querySelectorAll('input[type="number"]').forEach(i => i.addEventListener('input', update));

el('btnReset').addEventListener('click', reset);

// Init
update();
</script>
</body>
</html>
